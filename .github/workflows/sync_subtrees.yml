name: üîÅ Sync Subtrees

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main

jobs:
  sync-subtrees:
    name: üîÅ Sync and Push Subtrees
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for full subtree history

      - name: üõ† Set up Git
        run: |
          git config user.name "genie-coder-bot"
          git config user.email "bot@geniecoder.org"

      - name: üîÑ Sync all packages
        run: |
          set -e
          PACKAGES_DIR="packages"
          ORG_URL="https://github.com/GenieCoderSrc"

          echo "üîç Finding packages in $PACKAGES_DIR..."
          for dir in "$PACKAGES_DIR"/*/; do
            PACKAGE_NAME=$(basename "$dir")
            REPO_URL="$ORG_URL/$PACKAGE_NAME.git"

            echo ""
            echo "‚¨áÔ∏è Pulling from $PACKAGE_NAME..."
            git subtree pull --prefix="$PACKAGES_DIR/$PACKAGE_NAME" "$REPO_URL" main || echo "‚ö†Ô∏è Nothing to pull"
#            git subtree pull --prefix="$PACKAGES_DIR/$PACKAGE_NAME" "$REPO_URL" main --squash || echo "‚ö†Ô∏è Nothing to pull"

          done

          echo ""
          echo "üìù Commit changes if any..."
          git add $PACKAGES_DIR
          git commit -m "chore: sync all packages from subtree remotes" || echo "‚úÖ No changes to commit"

          for dir in "$PACKAGES_DIR"/*/; do
            PACKAGE_NAME=$(basename "$dir")
            REPO_URL="$ORG_URL/$PACKAGE_NAME.git"

            echo ""
            echo "‚¨ÜÔ∏è Pushing back to $PACKAGE_NAME..."
            git subtree push --prefix="$PACKAGES_DIR/$PACKAGE_NAME" "$REPO_URL" main || echo "‚ö†Ô∏è Nothing to push"
          done

          echo "‚úÖ All subtree sync operations complete."
